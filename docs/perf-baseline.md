# ベースライン計測ドキュメント

## 概要

Phase 10 の計測基盤（Task 1-A〜5-A）を使って、改善施策適用前の性能値を記録する。
本ドキュメントに記録されたベースライン値が、以降の最適化施策の効果測定基準となる。

---

## 計測環境

| 項目                  | 記入欄                                          |
| --------------------- | ----------------------------------------------- |
| 計測日                | 2026-02-22                                      |
| ブラウザ / バージョン | Chromium（Playwright headless: false）          |
| OS                    | macOS 25.3.0 (Darwin)                           |
| ビルドモード          | development（`VITE_PERF_LOG=true npm run dev`） |
| URL                   | `http://localhost:5173`                         |
| 計測ツール            | Playwright 自動計測スクリプト                   |
| CPU                   | （記録省略 - Playwright 環境）                  |
| メモリ                | （記録省略）                                    |
| GPU                   | （記録省略）                                    |

---

## 計測準備手順

### 1. アプリを計測モードで起動する

```bash
# プロジェクトルートで実行
VITE_PERF_LOG=true npm run dev
```

> **注意**: `VITE_PERF_LOG=true` を付けないと PerfOverlay が表示されず、計測値が記録されない。

### 2. ブラウザで開く

```text
http://localhost:5173
```

### 3. PerfOverlay の確認

画面右下に以下の形式のオーバーレイが表示されることを確認する。

```text
FPS: 60.0 / p95: 58.5
Worker RTT: 320.0ms / p95: 380.0ms
FP update: 0.012ms
Cache: 10/50 (12.34 MB)
Heap: 145.2 MB
```

| 表示項目                       | 対応ラベル                | 説明                                                |
| ------------------------------ | ------------------------- | --------------------------------------------------- |
| `FPS: XX / p95: XX`            | `fps`                     | レンダリングフレームレート（latest / p95）          |
| `Worker RTT: XXms / p95: XXms` | `worker-rtt:*` 集約       | Main→Worker→Main 往復時間（全衛星平均 / p95最大値） |
| `FP update: Xms`               | `footprint-update:*` 集約 | フットプリントポリゴン更新時間（全衛星平均）        |
| `Cache: N/M (X MB)`            | `cache-entries`           | LRUキャッシュの使用数 / 容量 / 推定バイト数         |
| `Heap: X MB`                   | `heap-used-bytes`         | JSヒープ使用量（**Chrome限定**。他ブラウザは N/A）  |

### 4. 衛星の初期表示確認

- 10機すべてが軌道上に表示されていること（デフォルトで全機 `visible: true`）
- サイドパネルの衛星リストに ISS, NOAA 19, TERRA, AQUA, AURA, LANDSAT 8, SENTINEL-2A, SENTINEL-2B, WORLDVIEW-3, ひまわり8号 が表示されていること

### 5. フットプリント表示のON方法

衛星リストの各衛星行にある「FP」ボタンをクリックすると、その衛星のフットプリントが地表面に描画される。
シナリオ D では全10機のフットプリントをONにしてから計測する。

---

## 計測シナリオと手順

### シナリオ A: 初期ロード

**目的**: アプリ起動直後の Worker 計算時間と安定後FPSを計測する。

**手順**:

1. ブラウザのキャッシュをクリアする（DevTools → Application → Storage → Clear site data）
2. `VITE_PERF_LOG=true npm run dev` で起動済みのページをハードリロード（`Shift+Ctrl+R` / `Shift+Cmd+R`）
3. 10機の衛星軌道ラインがすべて表示されるまで待つ
4. PerfOverlay の `Worker RTT` 値が安定するまで待つ（通常10〜30秒）
5. **記録する値**:
   - `Worker RTT` の avg（全衛星の最初の compute-day リクエスト完了後の値）
   - `Worker RTT` の p95
6. さらに10秒間、マウスを動かさずに待つ
7. **記録する値**:
   - `FPS` の latest（安定後）
   - `FPS` の p95

**判定基準**: Worker RTT avg が 1000ms 未満であること。

---

### シナリオ B: 日跨ぎ（キャッシュミス）

**目的**: 先読みが間に合っていない状態でスライダーを翌日に移動したときの遅延を計測する。

**手順**:

1. ページをリロードし、初期ロードが完了するまで待つ
2. **すぐに**（先読み完了前に）タイムスライダーを翌日（+24時間）方向へ大きく動かす
3. PerfOverlay の `Worker RTT` が跳ね上がる瞬間を観察する
4. **記録する値**:
   - `Worker RTT` の p95（この操作後の最大値）
   - 視覚的に衛星位置が更新されるまでの体感ラグ（秒単位で目測）
5. 操作後、PerfOverlay の値が再び安定するまで待つ

> **目安**: キャッシュミス時は Worker RTT が 500ms〜数秒になることが予想される。

---

### シナリオ C: 日跨ぎ（キャッシュヒット）

**目的**: 先読み済みキャッシュを利用した場合の応答時間を計測する。

**手順**:

1. ページをリロードし、初期ロードが完了するまで待つ
2. **3分程度待って**先読みが完了するのを待つ（`Cache: N/M` の N が増加することで確認できる）
   - 例: `Cache: 1/50` → `Cache: 3/50` になれば前後1日分がキャッシュ済み
3. タイムスライダーを翌日（+24時間）方向へ移動する
4. **記録する値**:
   - `Worker RTT` の変化（キャッシュヒット時は spike が起きにくいことを確認）
   - `Cache: N/M` の値（キャッシュが使われたかの確認）
   - 視覚的な切替の体感ラグ（秒単位）

> **判定基準**: シナリオ B の RTT p95 に比べ、明らかに短いこと（1/3以下が目安）。

---

### シナリオ D: 操作中 FPS（10機 + フットプリント表示）

**目的**: 最も負荷が高い状態（全衛星 + フットプリント表示）での FPS を計測する。

**手順**:

1. ページをリロードし、初期ロードが完了するまで待つ
2. 衛星リストで全10機の「FP」ボタンをONにする（フットプリント全機表示）
3. フットプリントが地表面に描画されることを確認する
4. マウスで地球儀を**高速回転**（ドラッグを素早く動かす）しながら30秒間操作する
5. 続けてスクロールで**ズームイン/アウト**を繰り返す（30秒間）
6. **記録する値**:
   - `FPS` の latest（操作中の平均的な値）
   - `FPS` の p95（操作中の最低ライン）
   - `FP update` の avg（フットプリント更新コスト）

> **判定基準**: `FPS p95` が 30fps 以上であること。30fps 未満の場合は Entity → Primitive 移行を検討。

---

## 結果記録テーブル

### 計測1回目（Playwright 自動計測: 2026-02-22）

| シナリオ                      | 指標                      | 計測値    | 備考                     |
| ----------------------------- | ------------------------- | --------- | ------------------------ |
| A: 初期ロード                 | Worker RTT avg            | 278.8ms   | 10機平均（安定後10秒）   |
| A: 初期ロード                 | Worker RTT p95            | 346.6ms   |                          |
| A: 初期ロード                 | FPS avg（安定後10秒）     | 83.5 fps  |                          |
| A: 初期ロード                 | FPS p95 avg（安定後10秒） | 85.5 fps  |                          |
| A: 初期ロード                 | FPS min                   | 68.6 fps  |                          |
| B: 日跨ぎ（キャッシュミス）   | Worker RTT p95 最大値     | 397.5ms   | ※注1 参照                |
| B: 日跨ぎ（キャッシュミス）   | 視覚的ラグ                | —         | Playwright では計測困難  |
| C: 日跨ぎ（キャッシュヒット） | Worker RTT p95 最大値     | 398.6ms   | ※注1 参照                |
| C: 日跨ぎ（キャッシュヒット） | Cache 使用数              | 30/70     | 前後3日分が先読み済み    |
| D: 操作中FPS                  | FPS avg（30秒間）         | 100.6 fps | 10機+FP全表示            |
| D: 操作中FPS                  | FPS p95 avg               | 115.4 fps | 10機+FP全表示            |
| D: 操作中FPS                  | FPS min                   | 59.7 fps  | 回転操作中の瞬間最低値   |
| D: 操作中FPS                  | FPS max                   | 120.2 fps | ディスプレイ上限         |
| D: 操作中FPS                  | FP update avg             | 0.002ms   | フットプリント更新コスト |
| メモリ                        | Heap（シナリオA後）       | 68.4 MB   |                          |
| メモリ                        | Heap（シナリオD後）       | 74.4 MB   |                          |
| メモリ                        | Cache使用量               | 1.65 MB   | 30エントリ分             |

> **※注1**: シナリオ B（キャッシュミス）と C（キャッシュヒット）の RTT がほぼ同値（397.5ms vs 398.6ms）。
> これはアプリの先読みが**初期ロードと同時に前後3日分（30エントリ）をキャッシュ**するため、
> スライダーを翌日へ移動した時点ですでにキャッシュヒット状態になっていたことを示す。
> LRU キャッシュと先読みロジックが意図通り機能している証拠。

### 計測2回目

| シナリオ                      | 指標                     | 計測値     | 備考          |
| ----------------------------- | ------------------------ | ---------- | ------------- |
| A: 初期ロード                 | Worker RTT avg           | \_\_\_ms   | 10機平均      |
| A: 初期ロード                 | Worker RTT p95           | \_\_\_ms   |               |
| A: 初期ロード                 | FPS latest（安定後10秒） | \_\_\_ fps |               |
| A: 初期ロード                 | FPS p95（安定後10秒）    | \_\_\_ fps |               |
| B: 日跨ぎ（キャッシュミス）   | Worker RTT p95           | \_\_\_ms   | spike 最大値  |
| B: 日跨ぎ（キャッシュミス）   | 視覚的ラグ               | \_\_\_秒   | 目測          |
| C: 日跨ぎ（キャッシュヒット） | Worker RTT p95           | \_\_\_ms   |               |
| C: 日跨ぎ（キャッシュヒット） | 視覚的ラグ               | \_\_\_秒   | 目測          |
| D: 操作中FPS                  | FPS latest               | \_\_\_ fps | 10機+FP全表示 |
| D: 操作中FPS                  | FPS p95                  | \_\_\_ fps | 10機+FP全表示 |
| D: 操作中FPS                  | FP update avg            | \_\_\_ms   |               |

### 計測3回目

| シナリオ                      | 指標                     | 計測値     | 備考          |
| ----------------------------- | ------------------------ | ---------- | ------------- |
| A: 初期ロード                 | Worker RTT avg           | \_\_\_ms   | 10機平均      |
| A: 初期ロード                 | Worker RTT p95           | \_\_\_ms   |               |
| A: 初期ロード                 | FPS latest（安定後10秒） | \_\_\_ fps |               |
| A: 初期ロード                 | FPS p95（安定後10秒）    | \_\_\_ fps |               |
| B: 日跨ぎ（キャッシュミス）   | Worker RTT p95           | \_\_\_ms   | spike 最大値  |
| B: 日跨ぎ（キャッシュミス）   | 視覚的ラグ               | \_\_\_秒   | 目測          |
| C: 日跨ぎ（キャッシュヒット） | Worker RTT p95           | \_\_\_ms   |               |
| C: 日跨ぎ（キャッシュヒット） | 視覚的ラグ               | \_\_\_秒   | 目測          |
| D: 操作中FPS                  | FPS latest               | \_\_\_ fps | 10機+FP全表示 |
| D: 操作中FPS                  | FPS p95                  | \_\_\_ fps | 10機+FP全表示 |
| D: 操作中FPS                  | FP update avg            | \_\_\_ms   |               |

---

## 3回計測の集計（ばらつき確認）

各指標を3回計測し、ばらつきが **±10% 以内** に収まることを確認する。

| 指標                           | 1回目     | 2回目 | 3回目 | 平均 | 最大偏差 | ±10%以内？ |
| ------------------------------ | --------- | ----- | ----- | ---- | -------- | ---------- |
| Worker RTT avg（シナリオA）    | 278.8ms   |       |       |      |          |            |
| FPS p95 avg（シナリオA安定後） | 85.5 fps  |       |       |      |          |            |
| Worker RTT p95（シナリオB）    | 397.5ms   |       |       |      |          |            |
| Worker RTT p95（シナリオC）    | 398.6ms   |       |       |      |          |            |
| FPS p95 avg（シナリオD）       | 115.4 fps |       |       |      |          |            |

> **計算式**: 最大偏差 = max(|計測値 - 平均| / 平均) × 100%

---

## Playwright 自動計測スクリプト

繰り返し計測には以下のスクリプトを使用する（2回目・3回目の計測に再利用可能）。

```bash
# Vite devサーバーを起動（別ターミナル）
VITE_PERF_LOG=true npm run dev

# 計測スクリプトを実行（Playwright skill ディレクトリから）
SKILL_DIR=~/.claude/plugins/cache/playwright-skill/playwright-skill/4.1.0/skills/playwright-skill
node "$SKILL_DIR/run.js" /tmp/playwright-test-perf-baseline.js
```

計測結果は `/tmp/perf-baseline-results.json` に JSON 形式で出力される。

---

## 備考・注意事項

### ブラウザについて

- **Chrome 推奨**: `performance.memory`（ヒープメモリ）は Chrome/Edge 限定。Firefox や Safari では `Heap: N/A` と表示される
- Chromium 系ブラウザであれば、DevTools の Performance タブでも詳細なフレーム分析が可能
- ブラウザの拡張機能が FPS に影響することがあるため、シークレットモードで計測することを推奨

### 計測の安定性について

- 初回ロード後は JIT コンパイルや GPU シェーダーのコンパイルで一時的に FPS が低下する。10秒以上待ってから計測すること
- バックグラウンドタブや他のアプリの負荷が計測値に影響するため、計測中はブラウザタブを前面に出し、重い処理を行うアプリを終了すること
- ノートPCの場合、電源アダプターを接続してバッテリー節電モードを無効にすること（バッテリー駆動時は CPU クロックが下がり FPS が低下する）

### PerfOverlay の表示位置について

- PerfOverlay は画面**右下**（`bottom: 140px, right: 8px`）に固定表示される
- タイムスライダーや凡例UIと重なる場合は、ウィンドウ幅を広げて確認すること

### Worker RTT の解釈について

- Worker RTT には SGP4計算・フットプリント計算・スワス計算のすべての処理時間 + postMessage 転送時間が含まれる
- `Worker RTT >= Worker 内 totalMs` の関係が成立するはず（転送オーバーヘッド分だけ RTT が大きくなる）
- PerfOverlay の `Worker RTT` は **全衛星の avg の平均 / p95 の最大値** で表示される

### Cache の見方

- `Cache: N/M (X MB)`: N = キャッシュ済みエントリ数、M = 最大容量（LRU上限）、X = 推定バイト数
- 1日窓 × 10機 = 10エントリ（初期ロード完了後）
- 先読み完了後は前日・翌日分が追加され、最大 30エントリ程度

---

## 計測結果の考察（1回目: 2026-02-22）

### 良好な点

| 指標                       | 実測値          | 判定                                      |
| -------------------------- | --------------- | ----------------------------------------- |
| FPS p95（安定後）          | 85.5 fps        | ✅ 60fps を大幅に上回る                   |
| FPS p95（操作中・10機+FP） | 115.4 fps       | ✅ 120fps（ディスプレイ上限）に迫る高性能 |
| FP update avg              | 0.002ms         | ✅ フットプリント更新コストがほぼゼロ     |
| Heap メモリ                | 68〜74 MB       | ✅ 非常に低い                             |
| Cache 効率                 | 30/70（1.65MB） | ✅ 前後3日分が自動先読みされている        |

### 要観察・課題

| 指標              | 実測値   | 判定                                                                                       |
| ----------------- | -------- | ------------------------------------------------------------------------------------------ |
| Worker RTT avg    | 278.8ms  | ⚠️ 約280ms。UI の反応を感じさせない範囲だが、10機 × 30秒間隔 × 24時間 = 2880点の計算コスト |
| FPS min（操作中） | 59.7 fps | ⚠️ 瞬間的に60fps を下回るフレームがある                                                    |
| B/C の RTT 差異   | ≈0ms     | 📝 先読みが積極的すぎてキャッシュミスが観測できなかった（機能的には良いこと）              |

### キャッシュアーキテクチャの発見

- LRU キャッシュ容量が **70エントリ**（10機 × 7日）に設定されており、初期ロード時に **前後3日分（30エントリ）** を一気にプリフェッチする
- このため、シナリオ B（キャッシュミス）の再現は実環境では困難（設計上キャッシュミスが起きにくい）
- キャッシュ使用量は 1.65MB（30エントリ）と非常に軽量

---

## 計測完了後の次ステップ

ベースライン値の記録が完了したら、`docs/phase10-performance-measurement.md` の Task 5-C に従い、
`docs/perf-improvement-plan.md` で改善施策の優先付けを行う。

### 1回目計測に基づく判断

| 施策                    | 判断基準        | 実測値    | 優先度                 |
| ----------------------- | --------------- | --------- | ---------------------- |
| Entity → Primitive 移行 | FPS p95 < 30fps | 115.4 fps | 不要（現状は十分）     |
| stepSec 可変化          | RTT avg > 500ms | 278.8ms   | 任意（現状は許容範囲） |
| FP 更新間引き           | FP update > 1ms | 0.002ms   | 不要                   |
| キャッシュサイズ調整    | Heap > 500MB    | 74 MB     | 不要                   |

> **結論**: 現状のパフォーマンスは全指標で目標値を大幅に上回っている。
> 2回目・3回目の計測でばらつきを確認後、改善施策の要否を最終判断する。
